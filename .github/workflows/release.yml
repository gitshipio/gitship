name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Downcase Repo Name
        run: |
          echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY@L}" >> "${GITHUB_ENV}"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/operator
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dashboard
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description="GitShip Operator and Dashboard"
            org.opencontainers.image.licenses=MIT

      # Build and Push Operator
      - name: Build and push Operator image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}/operator:${{ github.ref_name }}
          labels: ${{ steps.meta.outputs.labels }}

      # Build and Push Dashboard
      - name: Build and push Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}/dashboard:${{ github.ref_name }}
          labels: ${{ steps.meta.outputs.labels }}

      # Generate Install Manifest
      - name: Generate Install Manifest
        run: |
          mkdir -p dist
          
          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          mv kustomize /usr/local/bin/
          
          # Update Controller Image
          cd config/manager
          kustomize edit set image controller=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/operator:${{ github.ref_name }}
          cd ../..
          
          # Build Base Manifest
          kustomize build config/default > dist/install.yaml
          
          # Append Dashboard Manifests
          echo "---" >> dist/install.yaml
          cat deploy/dashboard/rbac.yaml >> dist/install.yaml
          echo "---" >> dist/install.yaml
          cat deploy/dashboard/service.yaml >> dist/install.yaml
          echo "---" >> dist/install.yaml
          
          # Dashboard Deployment with correct image
          sed "s|image: gitship-dashboard:latest|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}/dashboard:${{ github.ref_name }}|g" deploy/dashboard/deployment.yaml >> dist/install.yaml
          # Ensure PullPolicy is Always for release
          sed -i 's|imagePullPolicy: Never|imagePullPolicy: Always|g' dist/install.yaml

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/install.yaml
          generate_release_notes: true
